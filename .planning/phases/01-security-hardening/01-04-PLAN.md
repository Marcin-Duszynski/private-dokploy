# Plan 01-04: Scripts - Host Firewall + Docker Hardening

## Objective
Enable UFW firewall service, remove insecure iptables rules, and apply Docker security best practices.

## Context
@bin/dokploy-main.sh - Main instance with UFW rules but service not enabled
@bin/dokploy-worker.sh - Worker instance with UFW rules but service not enabled

## Tasks

### Task 1: Enable UFW in Main Script
- **Type:** edit
- **File:** `bin/dokploy-main.sh`
- **Action:** Add UFW enable and default deny policy before port rules:
```bash
# Firewall Configuration
ufw default deny incoming
ufw default allow outgoing
ufw allow 22/tcp comment 'SSH'
ufw allow 80/tcp comment 'HTTP'
ufw allow 443/tcp comment 'HTTPS'
ufw allow 81/tcp comment 'Traefik HTTP'
ufw allow 444/tcp comment 'Traefik HTTPS'
ufw allow from 10.0.0.0/16 to any port 3000 proto tcp comment 'Dokploy UI (VCN only)'
ufw allow from 10.0.0.0/16 to any port 2376 proto tcp comment 'Docker TLS (VCN only)'
ufw allow from 10.0.0.0/16 to any port 2377 proto tcp comment 'Swarm Manager (VCN only)'
ufw allow from 10.0.0.0/16 to any port 7946 comment 'Swarm Discovery (VCN only)'
ufw allow from 10.0.0.0/16 to any port 4789 proto udp comment 'Swarm Overlay (VCN only)'
ufw --force enable
```
- **Remove:** Redundant iptables rules (UFW manages iptables)
- **Verify:** Script contains `ufw --force enable`
- **Done:** UFW enabled with secure defaults on main

### Task 2: Enable UFW in Worker Script
- **Type:** edit
- **File:** `bin/dokploy-worker.sh`
- **Action:** Add UFW configuration for workers:
```bash
# Firewall Configuration
ufw default deny incoming
ufw default allow outgoing
ufw allow 22/tcp comment 'SSH'
ufw allow 80/tcp comment 'HTTP'
ufw allow 443/tcp comment 'HTTPS'
ufw allow from 10.0.0.0/16 to any port 2376 proto tcp comment 'Docker TLS (VCN only)'
ufw allow from 10.0.0.0/16 to any port 2377 proto tcp comment 'Swarm Manager (VCN only)'
ufw allow from 10.0.0.0/16 to any port 7946 comment 'Swarm Discovery (VCN only)'
ufw allow from 10.0.0.0/16 to any port 4789 proto udp comment 'Swarm Overlay (VCN only)'
ufw --force enable
```
- **Remove:** Redundant iptables rules
- **Verify:** Script contains `ufw --force enable`
- **Done:** UFW enabled with secure defaults on workers

### Task 3: Remove Insecure iptables Rules
- **Type:** edit
- **Files:** `bin/dokploy-main.sh`, `bin/dokploy-worker.sh`
- **Action:** Remove all direct iptables commands (UFW manages these):
```bash
# REMOVE ALL THESE:
iptables -I INPUT 1 -p tcp --dport 80 -j ACCEPT
iptables -I INPUT 1 -p tcp --dport 443 -j ACCEPT
# ... etc
netfilter-persistent save
```
- **Verify:** No `iptables -I` commands in scripts
- **Done:** iptables managed by UFW only

### Task 4: Add Docker Daemon Hardening
- **Type:** edit
- **File:** `bin/dokploy-main.sh`
- **Action:** Add Docker daemon security configuration after Docker install:
```bash
# Docker Daemon Hardening
mkdir -p /etc/docker
cat > /etc/docker/daemon.json << 'DOCKEREOF'
{
  "live-restore": true,
  "userland-proxy": false,
  "no-new-privileges": true,
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  },
  "storage-driver": "overlay2"
}
DOCKEREOF
systemctl restart docker
```
- **Verify:** Script creates `/etc/docker/daemon.json`
- **Done:** Docker daemon hardened

### Task 5: Add Automatic Security Updates
- **Type:** edit
- **Files:** `bin/dokploy-main.sh`, `bin/dokploy-worker.sh`
- **Action:** Enable unattended-upgrades for security patches:
```bash
# Enable automatic security updates
apt-get install -y unattended-upgrades
dpkg-reconfigure -plow unattended-upgrades
```
- **Verify:** Script installs unattended-upgrades
- **Done:** Automatic security updates enabled

## Verification
```bash
# Syntax check
bash -n bin/dokploy-main.sh
bash -n bin/dokploy-worker.sh

# Content verification
grep -q "ufw --force enable" bin/dokploy-main.sh
grep -q "daemon.json" bin/dokploy-main.sh
grep -q "unattended-upgrades" bin/dokploy-main.sh
! grep -q "iptables -I" bin/dokploy-main.sh
```

## Success Criteria
- [ ] UFW enabled with default deny on both scripts
- [ ] Swarm ports restricted to VCN CIDR (10.0.0.0/16)
- [ ] Direct iptables rules removed
- [ ] Docker daemon.json with security settings
- [ ] Automatic security updates enabled
- [ ] Scripts pass syntax validation
