# Plan 01-02: Terraform - Network Security (SSH Restriction)

## Objective
Restrict SSH access from internet-wide (0.0.0.0/0) to VCN-only or specified trusted CIDR, reducing brute-force attack surface.

## Context
@network.tf - Current security list with SSH open to 0.0.0.0/0

## Tasks

### Task 1: Add SSH Allowed CIDR Variable
- **Type:** edit
- **File:** `variables.tf`
- **Action:** Add new variable for SSH allowed CIDR with secure default
```hcl
variable "ssh_allowed_cidr" {
  description = "CIDR block allowed to SSH. Default restricts to VCN only. Set to your IP/32 for remote access."
  type        = string
  default     = "10.0.0.0/16"
}
```
- **Verify:** `grep -q "ssh_allowed_cidr" variables.tf`
- **Done:** SSH CIDR variable defined with VCN-only default

### Task 2: Update SSH Security List Rule
- **Type:** edit
- **File:** `network.tf`
- **Action:** Change SSH ingress rule source from `"0.0.0.0/0"` to `var.ssh_allowed_cidr`
- **Verify:** `grep -A5 "Allow SSH" network.tf | grep -q "var.ssh_allowed_cidr"`
- **Done:** SSH restricted to configurable CIDR

### Task 3: Update SSH Rule Description
- **Type:** edit
- **File:** `network.tf`
- **Action:** Update description to clarify restricted access
- **Verify:** `grep -q "SSH.*restricted" network.tf`
- **Done:** Description reflects security posture

## Verification
```bash
# Local validation
terraform validate

# Upload to OCI Resource Manager and run plan job
zip -r ../dokploy-update.zip . -x "*.git*" -x ".claude/*" -x ".planning/*" -x "doc/*"
oci resource-manager stack update --stack-id <stack-ocid> --config-source ../dokploy-update.zip
oci resource-manager job create-plan-job --stack-id <stack-ocid>
# Expected: Security list rule updated
```

## Success Criteria
- [ ] `ssh_allowed_cidr` variable exists with VCN default
- [ ] SSH ingress rule uses variable instead of 0.0.0.0/0
- [ ] `terraform validate` passes locally
- [ ] OCI Resource Manager plan job shows security list change

## Note
Users requiring remote SSH access should override via:
- OCI Resource Manager stack variables: set `ssh_allowed_cidr` to `YOUR_PUBLIC_IP/32`
- Or use OCI Bastion service (recommended)
