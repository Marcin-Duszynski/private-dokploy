# Plan 01-01: Terraform - IMDSv2 + OCI Agent Plugins

## Objective
Enable IMDSv2-only mode and activate OCI security agent plugins to protect against SSRF attacks and enable vulnerability detection.

## Context
@locals.tf - Current instance configuration with IMDSv1 enabled
@main.tf - Compute instances with security plugins disabled

## Tasks

### Task 1: Enable IMDSv2 Only
- **Type:** edit
- **File:** `locals.tf`
- **Action:** Change `are_legacy_imds_endpoints_disabled` from `false` to `true`
- **Verify:** `grep -q "are_legacy_imds_endpoints_disabled = true" locals.tf`
- **Done:** IMDSv2 enforced, legacy endpoints disabled

### Task 2: Enable Vulnerability Scanning Plugin
- **Type:** edit
- **File:** `main.tf`
- **Action:** Change Vulnerability Scanning `desired_state` from `DISABLED` to `ENABLED` for both main and worker instances
- **Verify:** `grep -A1 "Vulnerability Scanning" main.tf | grep -q "ENABLED"`
- **Done:** Vulnerability scanning active on all instances

### Task 3: Enable Management Agent Plugin
- **Type:** edit
- **File:** `main.tf`
- **Action:** Change Management Agent `desired_state` from `DISABLED` to `ENABLED` for both main and worker instances
- **Verify:** `grep -A1 "Management Agent" main.tf | grep -q "ENABLED"`
- **Done:** Management agent active for OS patching and monitoring

## Verification
```bash
# Local validation
terraform validate

# Upload to OCI Resource Manager and run plan job
zip -r ../dokploy-update.zip . -x "*.git*" -x ".claude/*" -x ".planning/*" -x "doc/*"
oci resource-manager stack update --stack-id <stack-ocid> --config-source ../dokploy-update.zip
oci resource-manager job create-plan-job --stack-id <stack-ocid>
# Expected: 2 resources to change (dokploy_main, dokploy_worker)
```

## Success Criteria
- [ ] IMDSv2 enforced (`are_legacy_imds_endpoints_disabled = true`)
- [ ] Vulnerability Scanning ENABLED on all instances
- [ ] Management Agent ENABLED on all instances
- [ ] `terraform validate` passes locally
- [ ] OCI Resource Manager plan job shows only expected changes
