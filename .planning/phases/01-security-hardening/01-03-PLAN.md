# Plan 01-03: Scripts - SSH Hardening

## Objective
Harden SSH configuration on all instances to enforce key-only authentication, disable root login, and apply connection security settings.

## Context
@bin/dokploy-main.sh - Main instance bootstrap with basic SSH setup
@bin/dokploy-worker.sh - Worker instance bootstrap with basic SSH setup

## Tasks

### Task 1: Harden SSH in Main Script
- **Type:** edit
- **File:** `bin/dokploy-main.sh`
- **Action:** Replace basic SSH config with hardened settings:
```bash
# SSH Hardening
cat >> /etc/ssh/sshd_config.d/99-hardening.conf << 'SSHEOF'
# Authentication
PermitRootLogin no
PubkeyAuthentication yes
PasswordAuthentication no
PermitEmptyPasswords no
ChallengeResponseAuthentication no

# Connection security
MaxAuthTries 3
MaxSessions 5
LoginGraceTime 30
ClientAliveInterval 300
ClientAliveCountMax 2

# Protocol hardening
X11Forwarding no
AllowAgentForwarding no
AllowTcpForwarding no
PermitTunnel no

# Logging
LogLevel VERBOSE
SSHEOF
systemctl restart sshd
```
- **Remove:** The `sed` command enabling root login and the root SSH key copy
- **Verify:** Script contains hardening config block
- **Done:** SSH hardened on main instance

### Task 2: Harden SSH in Worker Script
- **Type:** edit
- **File:** `bin/dokploy-worker.sh`
- **Action:** Apply same SSH hardening as main script
- **Remove:** The `sed` command enabling root login and the root SSH key copy
- **Verify:** Script contains hardening config block
- **Done:** SSH hardened on worker instances

### Task 3: Remove Root SSH Access
- **Type:** edit
- **Files:** `bin/dokploy-main.sh`, `bin/dokploy-worker.sh`
- **Action:** Remove the block copying SSH keys to root:
```bash
# REMOVE THIS BLOCK:
mkdir -p /root/.ssh
cp /home/ubuntu/.ssh/authorized_keys /root/.ssh/
chown root:root /root/.ssh/authorized_keys
chmod 600 /root/.ssh/authorized_keys
```
- **Verify:** No `/root/.ssh` references in scripts
- **Done:** Root SSH access disabled

## Verification
```bash
# Syntax check
bash -n bin/dokploy-main.sh
bash -n bin/dokploy-worker.sh

# Content verification
grep -q "PermitRootLogin no" bin/dokploy-main.sh
grep -q "PasswordAuthentication no" bin/dokploy-main.sh
! grep -q "/root/.ssh" bin/dokploy-main.sh
```

## Success Criteria
- [ ] SSH hardening config added to both scripts
- [ ] Root login disabled (`PermitRootLogin no`)
- [ ] Password authentication disabled
- [ ] Root SSH key copy removed
- [ ] Scripts pass syntax validation
